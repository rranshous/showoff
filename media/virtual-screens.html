<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline' 'unsafe-eval';">
    <title>Virtual Screens</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--vscode-font-family);
            background-color: var(--vscode-editor-background);
            color: var(--vscode-editor-foreground);
            margin: 0;
            padding: 10px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            border-bottom: 1px solid var(--vscode-panel-border);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        h1 {
            color: var(--vscode-titleBar-activeForeground);
            font-size: 1.2em;
            margin-bottom: 3px;
        }
        
        .subtitle {
            color: var(--vscode-descriptionForeground);
            font-size: 0.8em;
        }
        
        .screens-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0;
            overflow-y: auto;
            padding-right: 5px; /* Space for scrollbar */
        }
        
        .virtual-screen {
            background-color: var(--vscode-input-background);
            border: 1px solid var(--vscode-panel-border);
            border-radius: 6px;
            padding: 10px;
            min-height: 150px;
            max-height: 300px;
            flex: 0 0 auto; /* Don't shrink */
            margin-bottom: 10px;
        }
        
        .screen-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--vscode-foreground);
            font-size: 0.9em;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--vscode-panel-border);
        }
        
        .screen-content {
            color: var(--vscode-foreground);
            font-size: 0.85em;
            padding: 10px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .text-screen .screen-content {
            background-color: var(--vscode-editor-background);
            border: 1px solid var(--vscode-input-border);
            border-radius: 4px;
            padding: 12px;
            font-family: var(--vscode-editor-font-family);
        }
        
        .canvas-container {
            padding: 10px;
            text-align: center;
            background-color: var(--vscode-editor-background);
            border: 1px solid var(--vscode-input-border);
            border-radius: 4px;
        }
        
        .canvas-screen canvas {
            background-color: #f8f8f8;
            border: 1px solid var(--vscode-panel-border);
            border-radius: 2px;
            max-width: 100%;
            height: auto;
        }
        
        .placeholder {
            text-align: center;
            color: var(--vscode-descriptionForeground);
            font-style: italic;
            padding: 40px 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üñ•Ô∏è Virtual Screens</h1>
        <div class="subtitle">Multi-screen workspace for AI interaction</div>
    </div>
    
    <div class="screens-container" id="screensContainer">
        <div class="placeholder" id="emptyPlaceholder">
            No virtual screens active<br>
            Use #virtual_screens or ask AI to create screens
        </div>
    </div>
    
    <script>
        console.log('Virtual Screens webview loaded successfully!');
        

        


        // Sync screens from backend state
        function syncScreens(screens) {
            const container = document.getElementById('screensContainer');
            
            // Clear existing screens
            container.innerHTML = '';
            
            if (screens.length === 0) {
                const placeholder = document.createElement('div');
                placeholder.className = 'placeholder';
                placeholder.id = 'emptyPlaceholder';
                placeholder.innerHTML = 'No virtual screens active<br>Use #virtual_screens or ask AI to create screens';
                container.appendChild(placeholder);
            } else {
                screens.forEach(screen => {
                    const screenDiv = document.createElement('div');
                    screenDiv.className = `virtual-screen ${screen.type}-screen`;
                    screenDiv.id = `screen-${screen.id}`;
                    
                    if (screen.type === 'text') {
                        screenDiv.innerHTML = `
                            <div class="screen-title">${screen.title}</div>
                            <div class="screen-content" id="screen-${screen.id}-content">${screen.content}</div>
                        `;
                    } else { // canvas
                        screenDiv.innerHTML = `
                            <div class="screen-title">${screen.title}</div>
                            <div class="canvas-container">
                                <canvas id="screen-${screen.id}-canvas" width="300" height="200"></canvas>
                            </div>
                        `;
                        
                        // Execute canvas content
                        setTimeout(() => {
                            const canvas = document.getElementById(`screen-${screen.id}-canvas`);
                            if (canvas && screen.content) {
                                const ctx = canvas.getContext('2d');
                                try {
                                    // Clear with light background
                                    ctx.fillStyle = '#f8f8f8';
                                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                                    
                                    // Execute the JavaScript function
                                    const userFunction = new Function('ctx', 'canvas', screen.content);
                                    userFunction(ctx, canvas);
                                } catch (error) {
                                    console.error(`Error rendering canvas screen ${screen.id}:`, error);
                                    ctx.fillStyle = '#f8f8f8';
                                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                                    ctx.fillStyle = '#ff4444';
                                    ctx.font = '12px Arial';
                                    ctx.textAlign = 'left';
                                    ctx.textBaseline = 'top';
                                    ctx.fillText('Error: ' + error.message, 5, 5);
                                }
                            }
                        }, 0);
                    }
                    
                    container.appendChild(screenDiv);
                });
            }
            
            console.log(`Synced ${screens.length} screens to UI`);
        }
        
        // Handle messages from the extension
        window.addEventListener('message', event => {
            const message = event.data;
            console.log('Received message from extension:', message);
            
            switch (message.command) {
                case 'syncScreens':
                    syncScreens(message.screens);
                    break;
            }
        });
        


        // Send ready signal to extension
        if (typeof acquireVsCodeApi !== 'undefined') {
            const vscode = acquireVsCodeApi();
            vscode.postMessage({ command: 'webview-ready' });
        }
    </script>
</body>
</html>